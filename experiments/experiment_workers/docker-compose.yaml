networks:
  default:
    driver: bridge
  huawei1-net:
    driver: bridge
    ipam:
      config:
      - subnet: 192.168.1.0/24
  huawei2-net:
    driver: bridge
    ipam:
      config:
      - subnet: 192.168.2.0/24
  huawei3-net:
    driver: bridge
    ipam:
      config:
      - subnet: 192.168.3.0/24
  huawei4-net:
    driver: bridge
    ipam:
      config:
      - subnet: 192.168.4.0/24
  worker1-net:
    driver: bridge
    internal: true
    ipam:
      config:
      - subnet: 10.1.0.0/16
  worker2-net:
    driver: bridge
    internal: true
    ipam:
      config:
      - subnet: 10.2.0.0/16
  worker3-net:
    driver: bridge
    internal: true
    ipam:
      config:
      - subnet: 10.3.0.0/16
  worker4-net:
    driver: bridge
    internal: true
    ipam:
      config:
      - subnet: 10.4.0.0/16
services:
  huawei_smartax-site-1:
    build:
      context: .
      dockerfile: huawei_smartax.Dockerfile
    command: fastapi run fakenos-web.py
    depends_on:
    - worker-site-1
    environment:
    - HOSTNAME=huawei_smartax_site_1
    - CONFIGURATION_FILE=site_1.yaml.j2
    networks:
      huawei1-net:
        ipv4_address: 192.168.1.3
    ports:
    - 8001:8000
  huawei_smartax-site-2:
    build:
      context: .
      dockerfile: huawei_smartax.Dockerfile
    command: fastapi run fakenos-web.py
    depends_on:
    - worker-site-2
    environment:
    - HOSTNAME=huawei_smartax_site_2
    - CONFIGURATION_FILE=site_2.yaml.j2
    networks:
      huawei2-net:
        ipv4_address: 192.168.2.3
    ports:
    - 8002:8000
  huawei_smartax-site-3:
    build:
      context: .
      dockerfile: huawei_smartax.Dockerfile
    command: fastapi run fakenos-web.py
    depends_on:
    - worker-site-3
    environment:
    - HOSTNAME=huawei_smartax_site_3
    - CONFIGURATION_FILE=site_3.yaml.j2
    networks:
      huawei3-net:
        ipv4_address: 192.168.3.3
    ports:
    - 8003:8000
  huawei_smartax-site-4:
    build:
      context: .
      dockerfile: huawei_smartax.Dockerfile
    command: fastapi run fakenos-web.py
    depends_on:
    - worker-site-4
    environment:
    - HOSTNAME=huawei_smartax_site_4
    - CONFIGURATION_FILE=site_4.yaml.j2
    networks:
      huawei4-net:
        ipv4_address: 192.168.4.3
    ports:
    - 8004:8000
  rabbitmq:
    image: rabbitmq:management
    networks:
      default: null
      worker1-net:
        ipv4_address: 10.1.0.2
      worker2-net:
        ipv4_address: 10.2.0.2
      worker3-net:
        ipv4_address: 10.3.0.2
      worker4-net:
        ipv4_address: 10.4.0.2
    ports:
    - 5672:5672
    - 15672:15672
  worker-site-1:
    build:
      context: .
      dockerfile: worker.Dockerfile
    command: python worker.py
    depends_on:
    - rabbitmq
    environment:
    - RABBITMQ_IP=10.1.0.2
    - HUAWEI_SMARTAX_IP=192.168.1.3
    - HOSTNAME=worker_site_1
    - QUEUE_NAME=site_1
    - CONFIGURATION_FILE=site_1.yaml.j2
    networks:
      huawei1-net:
        ipv4_address: 192.168.1.2
      worker1-net:
        ipv4_address: 10.1.0.3
  worker-site-2:
    build:
      context: .
      dockerfile: worker.Dockerfile
    command: python worker.py
    depends_on:
    - rabbitmq
    environment:
    - RABBITMQ_IP=10.2.0.2
    - HUAWEI_SMARTAX_IP=192.168.2.3
    - HOSTNAME=worker_site_2
    - QUEUE_NAME=site_2
    - CONFIGURATION_FILE=site_2.yaml.j2
    networks:
      huawei2-net:
        ipv4_address: 192.168.2.2
      worker2-net:
        ipv4_address: 10.2.0.3
  worker-site-3:
    build:
      context: .
      dockerfile: worker.Dockerfile
    command: python worker.py
    depends_on:
    - rabbitmq
    environment:
    - RABBITMQ_IP=10.3.0.2
    - HUAWEI_SMARTAX_IP=192.168.3.3
    - HOSTNAME=worker_site_3
    - QUEUE_NAME=site_3
    - CONFIGURATION_FILE=site_3.yaml.j2
    networks:
      huawei3-net:
        ipv4_address: 192.168.3.2
      worker3-net:
        ipv4_address: 10.3.0.3
  worker-site-4:
    build:
      context: .
      dockerfile: worker.Dockerfile
    command: python worker.py
    depends_on:
    - rabbitmq
    environment:
    - RABBITMQ_IP=10.4.0.2
    - HUAWEI_SMARTAX_IP=192.168.4.3
    - HOSTNAME=worker_site_4
    - QUEUE_NAME=site_4
    - CONFIGURATION_FILE=site_4.yaml.j2
    networks:
      huawei4-net:
        ipv4_address: 192.168.4.2
      worker4-net:
        ipv4_address: 10.4.0.3
